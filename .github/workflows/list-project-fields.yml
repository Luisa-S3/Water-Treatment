name: list project fields

on:
  workflow_dispatch:

jobs:
  list-fields:
    runs-on: ubuntu-latest
    steps:
      - name: List fields in user project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PROJECT_TOKEN }}
          script: |
            const username = "Luisa-S3"; // <- cámbialo si aplica
            const projectNumber = 1;     // <- cámbialo por el número de la URL (ProjectV2)

            const query = `
              query($login: String!, $number: Int!) {
                user(login: $login) {
                  projectV2(number: $number) {
                    id
                    title
                    fields(first: 50) {
                      nodes {
                        __typename
                        ... on ProjectV2FieldCommon {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          dataType
                          options(first: 100) {
                            nodes { id name }
                          }
                        }
                        ... on ProjectV2TextField {
                          dataType
                        }
                        ... on ProjectV2NumberField {
                          dataType
                        }
                        ... on ProjectV2DateField {
                          dataType
                        }
                        ... on ProjectV2IterationField {
                          dataType
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query, {
              login: username,
              number: projectNumber
            });

            const proj = result.user?.projectV2;
            if (!proj) {
              core.setFailed("No se encontró el proyecto. Verifica login/number y el scope del token (project read).");
              return;
            }

            console.log("📌 Project title:", proj.title);
            console.log("🆔 Project ID:", proj.id);
            console.log("📋 Campos:");

            for (const field of proj.fields.nodes) {
              const name = field.name ?? "(sin nombre)";
              const id = field.id ?? "(sin id)";
              const type = field.__typename ?? "(desconocido)";
              const dt = field.dataType ?? "(n/a)";
              console.log(`➡️  ${name} | ID: ${id} | __typename: ${type} | dataType: ${dt}`);

              // Si es SingleSelect, lista opciones
              if (type === "ProjectV2SingleSelectField" && field.options?.nodes?.length) {
                for (const opt of field.options.nodes) {
                  console.log(`    - opción: ${opt.name} (${opt.id})`);
                }
              }
            }
